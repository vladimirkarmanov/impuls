<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>АТП</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
          integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2"
          crossorigin="anonymous">
</head>

<body>
<section class="container mb-5">
    <h1 class="text-center mt-3">Распределение на группы</h1>
    {% if error_msg %}
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>{{ error_msg }}</strong> Проверьте файл перед загрузкой.
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    {% endif %}
    <div class="row card" style="padding: 10px;">
        <form id="students-form" method="post">
            {% csrf_token %}
            <div class="col-12">
                <table id="group-table">
                    <tr>
                        <td>Сотрудник</td>
                        <td>Ученая степень</td>
                        <td>Ученое звание</td>
                        <td>Базовый уровень знаний</td>
                        <td>Базовая квалификация</td>
                    </tr>
                    {% for student in students %}
                        <tr class="group-tr">
                            <td><input class="form-control input-group-text" type="text" value="{{ student.0 }}" required></td>
                            <td><input class="form-control input-group-text" type="number" value="{{ student.1 }}" required step="any"></td>
                            <td><input class="form-control input-group-text" type="number" value="{{ student.2 }}" required step="any"></td>
                            <td><input class="form-control input-group-text" type="number" value="{{ student.3 }}" required step="any"></td>
                            <td><input class="form-control input-group-text" type="number" value="{{ student.4 }}" required step="any"></td>
                        </tr>
                    {% empty %}
                        <tr class="group-tr">
                            <td><input class="form-control input-group-text" type="text" required></td>
                            <td><input class="form-control input-group-text" type="number" required step="any"></td>
                            <td><input class="form-control input-group-text" type="number" required step="any"></td>
                            <td><input class="form-control input-group-text" type="number" required step="any"></td>
                            <td><input class="form-control input-group-text" type="number" required step="any"></td>
                        </tr>
                    {% endfor %}
                </table>
            </div>
            <div class="col-12 mt-2">
                <button class="btn btn-primary mr-2" id="add-btn-group" type="button">Добавить</button>
                <button class="btn btn-success" id="result-group-btn" type="submit">Распределить</button>
                <button class="btn btn-danger" id="reset-btn" type="reset">Очистить</button>
            </div>
        </form>
        <form class="mt-3" method="post" enctype="multipart/form-data" action="{% url 'atp:main' %}">
            {% csrf_token %}
            <input type="file" name="csvfile">
            <button type="submit">Загрузить</button>
        </form>
    </div>
    <div id="result-group" class="row mt-5 justify-content-around"></div>
</section>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>
<script>
	let addBtnGroup = document.querySelector('#add-btn-group'),
		groupTable = document.querySelector('#group-table'),
		resultGroup = document.querySelector('#result-group'),
        studentsForm = document.querySelector('#students-form'),
        resetBtn = document.querySelector('#reset-btn');

	addBtnGroup.addEventListener('click', function() {
		groupTable.appendChild(createTrGroup());
	});

	resetBtn.addEventListener('click', function() {
		let inputs = studentsForm.querySelectorAll('input');
		for (let i = 0; i < inputs.length; i++) {
			inputs[i].defaultValue = '';
        }
		let groupRows = document.querySelectorAll('.group-tr');
		for (let i = 1; i < groupRows.length; i++) {
			groupRows[i].remove();
        }
    })

	studentsForm.addEventListener('submit', function(e) {
		e.preventDefault();
		(async () => {
			let groupRows = document.querySelectorAll('.group-tr');

			let body = [];
			for (let i = 0; i < groupRows.length; i++) {
				let rowColumns = groupRows[i].querySelectorAll('td');
				if (hasEmptyValues(rowColumns)) continue;
				let record = {
					name: rowColumns[0].querySelector('input').value.trim(),
					academicDegree: rowColumns[1].querySelector('input').value.trim(),
					academicRank: rowColumns[2].querySelector('input').value.trim(),
					basicLevel: rowColumns[3].querySelector('input').value.trim(),
					basicQualification: rowColumns[4].querySelector('input').value.trim(),
                };
                body.push(record);
            }
			const rawResponse = await fetch('{% url "atp:cluster_analysis" %}', {
				method: 'POST',
				headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(body)
			});

			const content = await rawResponse.json();
			console.log(content)
			showGroupsResult(content);
		})();
	});

	function showGroupsResult(content) {
		resultGroup.querySelectorAll('.card').forEach(function(card) {
			card.remove();
        })
        for (let i = 1; i < Object.keys(content).length + 1; i++) {
			let card = document.createElement('div'),
				cardHeader = document.createElement('div'),
				cardBody = document.createElement('div');
			card.setAttribute('class', 'card border-dark mb-3 col-4');
			card.setAttribute('style', 'max-width: 18rem;');
			cardHeader.setAttribute('class', 'card-header');
			cardBody.setAttribute('class', 'card-body text-dark');
			card.appendChild(cardHeader);
			card.appendChild(cardBody);
        	for (let j = 0; j < content[`${i}`].length; j++) {
        		cardHeader.textContent = `Группа ${i}`;
				let cardText = document.createElement('div');
				cardText.setAttribute('class', 'card-text');
				cardText.textContent = `${content[`${i}`][j].name} | ${content[`${i}`][j].academicDegree} | ${content[`${i}`][j].academicRank} | ${content[`${i}`][j].basicLevel} | ${content[`${i}`][j].basicQualification}`;
				cardBody.appendChild(cardText);
            }
			resultGroup.appendChild(card);
		}
    }

	function hasEmptyValues(columns) {
		for (let i = 0; i < columns.length; i++) {
			if (columns[0].querySelector('input').value.trim() === '') {
				return true;
            }
        }
		return false;
    }

	function createTrGroup() {
		let tr = document.createElement('tr'),
			td = document.createElement('td'),
			txtInput = document.createElement('input');

		tr.setAttribute('class', 'group-tr');
		txtInput.setAttribute('type', 'text');
		txtInput.classList.add('form-control');
		txtInput.classList.add('input-group-text');
		td.appendChild(txtInput);
		tr.appendChild(td);

		for (let i = 0; i < 4; i++) {
			let td = document.createElement('td'),
				input = document.createElement('input');
			input.setAttribute('type', 'number');
			input.setAttribute('step', 'any');
			input.classList.add('form-control');
			input.classList.add('input-group-text');
			td.appendChild(input);
			tr.appendChild(td);
		}
		return tr;
	}
</script>
</body>

</html>