{% extends "base.html" %}
{% load static %}

{% block page_title %}
    Отчет
{% endblock %}

{% block style %}
    <style>
        #training-nav > .nav-item {
            margin-right: 10px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="row text-center">
            <div class="card-body">
                <h5 class="card-title">Анализ данных повышения квалификации</h5>
                {% if error_msg %}
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <strong>{{ error_msg }}</strong> Проверьте файл перед загрузкой.
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endif %}
                <div class="row" style="padding: 10px;">
                    <form id="students-form" method="post">
                        {% csrf_token %}
                        <div class="col-12">
                            <table id="group-table">
                                <tr>
                                    <td>Сотрудник</td>
                                    <td>Ученая степень</td>
                                    <td>Ученое звание</td>
                                    <td>Квалиф. категория</td>
                                    <td>Сколько не повышал квалиф., мес</td>
                                </tr>
                                {% for student in students %}
                                    <tr class="group-tr">
                                        <td><input class="form-control input-group-text" type="text"
                                                   value="{{ student.0 }}" required></td>
                                        <td><input class="form-control input-group-text" type="number"
                                                   value="{{ student.1 }}" required step="any"></td>
                                        <td><input class="form-control input-group-text" type="number"
                                                   value="{{ student.2 }}" required step="any"></td>
                                        <td><input class="form-control input-group-text" type="number"
                                                   value="{{ student.3 }}" required step="any"></td>
                                        <td><input class="form-control input-group-text" type="number"
                                                   value="{{ student.4 }}" required step="any"></td>
                                    </tr>
                                {% empty %}
                                    <tr class="group-tr">
                                        <td><input class="form-control input-group-text" type="text" required></td>
                                        <td><input class="form-control input-group-text" type="number" required
                                                   step="any"></td>
                                        <td><input class="form-control input-group-text" type="number" required
                                                   step="any"></td>
                                        <td><input class="form-control input-group-text" type="number" required
                                                   step="any"></td>
                                        <td><input class="form-control input-group-text" type="number" required
                                                   step="any"></td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                        <div class="col-12 mt-2">
                            <button class="btn btn-success" id="result-group-btn" type="submit">Анализ</button>
                        </div>
                    </form>
                    <form class="mt-3" method="post" action="{% url 'report:index' %}">
                        {% csrf_token %}
                        <button class="btn btn-primary mr-2" id="add-btn-group" type="submit">Загрузить данные</button>
                    </form>
                </div>
                <div id="result-group" class="mt-5 row justify-content-center"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script>
		let addBtnGroup = document.querySelector('#add-btn-group'),
			groupTable = document.querySelector('#group-table'),
			resultGroup = document.querySelector('#result-group'),
			studentsForm = document.querySelector('#students-form'),
			resetBtn = document.querySelector('#reset-btn');

		studentsForm.addEventListener('submit', function(e) {
			e.preventDefault();
			(async () => {
				let groupRows = document.querySelectorAll('.group-tr');

				let body = [];
				for (let i = 0; i < groupRows.length; i++) {
					let rowColumns = groupRows[i].querySelectorAll('td');
					if (hasEmptyValues(rowColumns)) continue;
					let record = {
						name: rowColumns[0].querySelector('input').value.trim(),
						academicDegree: rowColumns[1].querySelector('input').value.trim(),
						academicRank: rowColumns[2].querySelector('input').value.trim(),
						qualificationCategory: rowColumns[3].querySelector('input').value.trim(),
						monthsWithoutTraining: rowColumns[4].querySelector('input').value.trim(),
					};
					body.push(record);
				}
				const rawResponse = await fetch('{% url "report:analysis_process" %}', {
					method: 'POST',
					headers: {
						'Accept': 'application/json',
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(body)
				});

				const content = await rawResponse.json();
				console.log(content)
				showGroupsResult(content);
			})();
		});

		function showGroupsResult(content) {
			resultGroup.querySelectorAll('.card').forEach(function(card) {
				card.remove();
			})
			for (let i = 1; i < Object.keys(content).length + 1; i++) {
				let card = document.createElement('div'),
					cardHeader = document.createElement('div'),
					cardBody = document.createElement('div');
				card.setAttribute('class', 'card border-dark mb-3 col-8 text-start');
				cardHeader.setAttribute('class', 'card-header text-center');
				cardBody.setAttribute('class', 'card-body text-dark');
				card.appendChild(cardHeader);
				card.appendChild(cardBody);
				for (let j = 0; j < content[`${i}`].length; j++) {
					cardHeader.textContent = `${content[`${i}`][j].groupName}`;
					let cardText = document.createElement('div');
					cardText.setAttribute('class', 'card-text');
					let name = content[`${i}`][j].name;
					let academicDegree = content[`${i}`][j].academicDegree;
					if (academicDegree === 0) {
						academicDegree = 'Кандидат наук';
                    } else if (academicDegree === 1) {
						academicDegree = 'Доктор наук';
                    }
					let academicRank = content[`${i}`][j].academicRank;
					if (academicRank === 0) {
						academicRank = 'Доцент';
					} else if (academicRank === 1) {
						academicRank = 'Профессор';
					}
					let qualificationCategory = content[`${i}`][j].qualificationCategory;
					if (qualificationCategory === 0) {
						qualificationCategory = 'Первая квалификационная категория';
					} else if (qualificationCategory === 1) {
						qualificationCategory = 'Высшая квалификационная категория';
					}
					let monthsWithoutTraining = content[`${i}`][j].monthsWithoutTraining;
					cardText.textContent = `${name} | ${academicDegree} | ${academicRank} | ${qualificationCategory} | ${monthsWithoutTraining} мес`;
					cardBody.appendChild(cardText);
				}
				resultGroup.appendChild(card);
			}
		}

		function hasEmptyValues(columns) {
			for (let i = 0; i < columns.length; i++) {
				if (columns[0].querySelector('input').value.trim() === '') {
					return true;
				}
			}
			return false;
		}

		function createTrGroup() {
			let tr = document.createElement('tr'),
				td = document.createElement('td'),
				txtInput = document.createElement('input');

			tr.setAttribute('class', 'group-tr');
			txtInput.setAttribute('type', 'text');
			txtInput.classList.add('form-control');
			txtInput.classList.add('input-group-text');
			td.appendChild(txtInput);
			tr.appendChild(td);

			for (let i = 0; i < 4; i++) {
				let td = document.createElement('td'),
					input = document.createElement('input');
				input.setAttribute('type', 'number');
				input.setAttribute('step', 'any');
				input.classList.add('form-control');
				input.classList.add('input-group-text');
				td.appendChild(input);
				tr.appendChild(td);
			}
			return tr;
		}
    </script>
{% endblock %}