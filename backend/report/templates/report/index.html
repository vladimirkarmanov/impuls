{% extends "base.html" %}
{% load static %}

{% block page_title %}
    Отчет
{% endblock %}

{% block style %}
    <style>
        #training-nav > .nav-item {
            margin-right: 10px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="row text-center">
            <div class="card-body">
                <h5 class="card-title">Анализ данных повышения квалификации</h5>
                {% if error_msg %}
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <strong>{{ error_msg }}</strong>
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                {% endif %}
                <div class="row" style="padding: 10px;">
                    <form id="students-form" method="post">
                        {% csrf_token %}
                        <div class="col-12">
                            <table id="group-table">
                                <tr>
                                    <td>Сотрудник</td>
                                    <td>Ученая степень</td>
                                    <td>Ученое звание</td>
                                    <td>Квалиф. категория</td>
                                    <td>Год последнего повышения квалиф.</td>
                                </tr>
                                {% for student in students %}
                                    <tr class="group-tr">
                                        <td><input class="form-control input-group-text" type="text"
                                                   value="{{ student.0 }}" required></td>
                                        <td><input class="form-control input-group-text" type="text"
                                                   value="{{ student.1 }}" required></td>
                                        <td><input class="form-control input-group-text" type="text"
                                                   value="{{ student.2 }}" required></td>
                                        <td><input class="form-control input-group-text"
                                                   value="{{ student.3 }}" required></td>
                                        <td><input class="form-control input-group-text" type="text"
                                                   value="{{ student.4 }}" required></td>
                                    </tr>
                                {% empty %}
                                    <tr class="group-tr">
                                        <td><input class="form-control input-group-text" type="text" required></td>
                                        <td><input class="form-control input-group-text" type="text" required></td>
                                        <td><input class="form-control input-group-text" type="text" required></td>
                                        <td><input class="form-control input-group-text" type="text" required></td>
                                        <td><input class="form-control input-group-text" type="text" required></td>
                                    </tr>
                                {% endfor %}
                            </table>
                        </div>
                        <div class="col-12 mt-2">
                            <button class="btn btn-success" id="result-group-btn" type="submit">Анализ</button>
                        </div>
                    </form>
                    <form class="mt-3" method="post" action="{% url 'report:index' %}">
                        {% csrf_token %}
                        <button class="btn btn-primary mr-2" id="add-btn-group" type="submit">Загрузить данные</button>
                    </form>
                </div>
                <div id="result-group" class="mt-5 row justify-content-center"></div>
            </div>
        </div>
    </div>
{% endblock %}

{% block js %}
    <script>
		let addBtnGroup = document.querySelector('#add-btn-group'),
			groupTable = document.querySelector('#group-table'),
			resultGroup = document.querySelector('#result-group'),
			studentsForm = document.querySelector('#students-form'),
			resetBtn = document.querySelector('#reset-btn');

		studentsForm.addEventListener('submit', function(e) {
			e.preventDefault();
			(async () => {
				let groupRows = document.querySelectorAll('.group-tr');

				let body = [];
				for (let i = 0; i < groupRows.length; i++) {
					let rowColumns = groupRows[i].querySelectorAll('td');
					if (hasEmptyValues(rowColumns)) continue;
					let record = {
						name: rowColumns[0].querySelector('input').value.trim(),
						academicDegree: rowColumns[1].querySelector('input').value.trim(),
						academicRank: rowColumns[2].querySelector('input').value.trim(),
						qualificationCategory: rowColumns[3].querySelector('input').value.trim(),
						lastTrainingYear: rowColumns[4].querySelector('input').value.trim(),
					};
					body.push(record);
				}
				const rawResponse = await fetch('{% url "report:analysis_process" %}', {
					method: 'POST',
					headers: {
						'Accept': 'application/json',
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(body)
				});

				const content = await rawResponse.json();
				if ('error' in content) {
					if (resultGroup.querySelector('.alert') !== null) {
						resultGroup.querySelector('.alert').remove();
					}
					let alert = document.createElement('div'),
                        strong = document.createElement('strong');
					alert.setAttribute('class', 'alert alert-danger');
					strong.textContent = content.error;
					alert.appendChild(strong);
					resultGroup.appendChild(alert);
				} else {
					createResultTable(content);
				}
			})();
		});

		function createResultTable(content) {
			if (resultGroup.querySelector('.table') !== null) {
				resultGroup.querySelector('.table').remove();
            }

			let table = document.createElement('table'),
				thead = document.createElement('thead'),
				tbody = document.createElement('tbody');

			table.setAttribute('class', 'table text-start');

			let headers = ['ФИО', 'Ученая степень', 'Ученое звание', 'Квалиф. категория', 'Год последнего повышения квалиф.', 'Примечание'];
			let tr = document.createElement('tr');
			for (let i = 0; i < headers.length; i++) {
				let th = document.createElement('th');
				th.setAttribute('scope', 'col');
				th.textContent = headers[i];
				tr.appendChild(th);
			}
			thead.appendChild(tr);

			let colors = ['#7FA848', '#48A8A8', '#5D65B0', '#B8B8B8', '#BB7861']
			for (let i = 1; i < Object.keys(content).length + 1; i++) {
				for (let j = 0; j < content[`${i}`].length; j++) {
					let tr = document.createElement('tr');
					tr.style.backgroundColor = colors[i-1];
					let groupName = content[`${i}`][j].groupName,
						name = content[`${i}`][j].name,
						academicDegree = content[`${i}`][j].academicDegree,
						academicRank = content[`${i}`][j].academicRank,
						qualificationCategory = content[`${i}`][j].qualificationCategory,
						lastTrainingYear = content[`${i}`][j].lastTrainingYear;
					let data = [name, academicDegree, academicRank, qualificationCategory, lastTrainingYear, groupName];
					for (let i = 0; i < data.length; i++) {
						let td = document.createElement('td');
						td.textContent = data[i];
						tr.appendChild(td);
					}
					tbody.appendChild(tr);
				}
			}
			table.appendChild(thead);
			table.appendChild(tbody);
			resultGroup.appendChild(table);
		}

		function hasEmptyValues(columns) {
			for (let i = 0; i < columns.length; i++) {
				if (columns[0].querySelector('input').value.trim() === '') {
					return true;
				}
			}
			return false;
		}

		function createTrGroup() {
			let tr = document.createElement('tr'),
				td = document.createElement('td'),
				txtInput = document.createElement('input');

			tr.setAttribute('class', 'group-tr');
			txtInput.setAttribute('type', 'text');
			txtInput.classList.add('form-control');
			txtInput.classList.add('input-group-text');
			td.appendChild(txtInput);
			tr.appendChild(td);

			for (let i = 0; i < 4; i++) {
				let td = document.createElement('td'),
					input = document.createElement('input');
				input.setAttribute('type', 'number');
				input.setAttribute('step', 'any');
				input.classList.add('form-control');
				input.classList.add('input-group-text');
				td.appendChild(input);
				tr.appendChild(td);
			}
			return tr;
		}
    </script>
{% endblock %}